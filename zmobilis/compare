#!/bin/bash

# Launch opm.R inside the R prompt (or RStudio)
# source('opm.R')
# Import the results of opm inside a DuctApe project
dape -p opm.db init
dape -p opm.db add ZM4
for i in $(ls *.yml)
do
    org=$(echo $i | awk 'BEGIN { FS = "_" } ; {print $1}')
    dphenome -p opm.db add $i $org
done
# We have subtracted the zero signals in the first ductape run, so we need to "manually" inform the DB
echo 'update biolog_exp set zero=1 where plate_id in (select distinct plate_id from biolog where zero_well_id is not null);' | sqlite3 opm.db
# Calculate the AV with the parameters generated by opm
dphenome -p opm.db start -g -n 6
dphenome -p opm.db export -j
# opm is ready
mv phenome_avg_ZM4.tsv opm.tsv

# Go for the actual comparison
# List the compounds with AV >= 3
cat ductape.tsv | awk 'BEGIN {FS = "\t"}; {if ($7 >= 3) print $1"_"$2"\t"$3"\t"$4}' > ductape_res.tsv
cat opm.tsv | awk 'BEGIN {FS = "\t"}; {if ($7 >= 3) print $1"_"$2"\t"$3"\t"$4}' > opm_res.tsv
# List compound with AV < 3
cat ductape.tsv | awk 'BEGIN {FS = "\t"}; {if ($7 < 3) print $1"_"$2"\t"$3"\t"$4}' > ductape_sens.tsv
cat opm.tsv | awk 'BEGIN {FS = "\t"}; {if ($7 < 3) print $1"_"$2"\t"$3"\t"$4}' > opm_sens.tsv

# Compare ductape vs opm
for i in $(cat ductape_res.tsv | awk '{print $1}')
do
    if ( grep -q "$i" opm_res.tsv )
    then
        echo -e $i"\t*" >> both_res.tsv
    else
        echo -e $i"\t" >> both_res.tsv
    fi
done
for i in $(cat ductape_sens.tsv | awk '{print $1}')
do
    if ( grep -q "$i" opm_sens.tsv )
    then
        echo -e $i"\t*" >> both_sens.tsv
    else
        echo -e $i"\t" >> both_sens.tsv
    fi
done
